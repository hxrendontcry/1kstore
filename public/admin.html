<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | 1K Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Kanit', 'sans-serif'] } } } }
    </script>
    <style>body { background-color: #0f172a; color: #e2e8f0; }</style>
</head>
<body class="p-6 max-w-6xl mx-auto">

    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white">üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Admin)</h1>
        <a href="/" class="px-4 py-2 bg-slate-800 rounded hover:bg-slate-700 transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1 bg-slate-800 p-6 rounded-xl border border-white/10 h-fit sticky top-6">
            <h2 id="form-title" class="text-xl font-bold text-yellow-400 mb-4">‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
            <input type="hidden" id="p-id"> <div class="space-y-4">
                <input id="p-name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
                <textarea id="p-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white h-24"></textarea>
                <input id="p-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
                <input id="p-image" type="text" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
                <textarea id="p-stock" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏±‡∏ö (ID/Pass) ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white h-24 font-mono text-sm text-yellow-200"></textarea>
                
                <button onclick="saveProduct()" id="btn-save" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded transition">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
                <button onclick="resetForm()" id="btn-cancel" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-2 rounded transition hidden">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-slate-800 rounded-xl border border-white/10 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-900 text-slate-400">
                        <tr>
                            <th class="p-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="p-4 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="product-list" class="divide-y divide-slate-700">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('user_id');

        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function init() {
            if(!userId) return window.location.href = '/login.html';
            loadProducts();
        }

        async function loadProducts() {
            const res = await fetch('/api/get_products'); // ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const products = await res.json();
            const list = document.getElementById('product-list');
            list.innerHTML = '';

            products.forEach(p => {
                const status = p.is_sold 
                    ? '<span class="px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>' 
                    : '<span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</span>';
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON string ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô edit (‡∏ï‡πâ‡∏≠‡∏á escape ‡πÉ‡∏´‡πâ‡∏î‡∏µ)
                const dataStr = encodeURIComponent(JSON.stringify(p));

                list.innerHTML += `
                    <tr class="hover:bg-slate-700/50 transition">
                        <td class="p-4">
                            <div class="font-bold text-white">${p.name}</div>
                            <div class="text-xs text-slate-500 truncate w-48">${p.stock_content}</div>
                        </td>
                        <td class="p-4 text-right font-mono text-yellow-400">${p.price}.-</td>
                        <td class="p-4 text-center">${status}</td>
                        <td class="p-4 text-center space-x-2">
                            <button onclick="startEdit('${dataStr}')" class="text-blue-400 hover:text-blue-300 text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-300 text-sm">‡∏•‡∏ö</button>
                        </td>
                    </tr>
                `;
            });
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
        async function saveProduct() {
            const id = document.getElementById('p-id').value;
            const action = id ? 'edit' : 'add'; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

            const payload = {
                userId,
                action,
                id,
                name: document.getElementById('p-name').value,
                description: document.getElementById('p-desc').value,
                price: document.getElementById('p-price').value,
                image: document.getElementById('p-image').value,
                stock_content: document.getElementById('p-stock').value
            };

            if(!payload.name || !payload.price || !payload.stock_content) {
                return Swal.fire({icon:'warning', title:'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', background:'#1e293b', color:'#fff'});
            }

            Swal.showLoading();
            const res = await fetch('/api/admin_products', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if(data.success) {
                Swal.fire({icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:data.msg, background:'#1e293b', color:'#fff'});
                resetForm();
                loadProducts();
            } else {
                Swal.fire({icon:'error', title:'‡∏û‡∏•‡∏≤‡∏î', text:data.msg, background:'#1e293b', color:'#fff'});
            }
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö
        async function deleteProduct(id) {
            const confirm = await Swal.fire({
                title: '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?',
                text: "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                background:'#1e293b', color:'#fff'
            });

            if (confirm.isConfirmed) {
                const res = await fetch('/api/admin_products', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId, action: 'delete', id })
                });
                loadProducts();
            }
        }

        // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°)
        function startEdit(encodedData) {
            const p = JSON.parse(decodeURIComponent(encodedData));
            
            document.getElementById('form-title').innerText = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ' + p.name;
            document.getElementById('btn-save').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.getElementById('btn-save').classList.replace('bg-green-600', 'bg-blue-600');
            document.getElementById('btn-save').classList.replace('hover:bg-green-500', 'hover:bg-blue-500');
            document.getElementById('btn-cancel').classList.remove('hidden');

            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-desc').value = p.description;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-image').value = (p.images && p.images.length) ? p.images[0] : '';
            document.getElementById('p-stock').value = p.stock_content;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 5. ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        function resetForm() {
            document.getElementById('form-title').innerText = '‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('btn-save').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            document.getElementById('btn-save').classList.replace('bg-blue-600', 'bg-green-600');
            document.getElementById('btn-save').classList.replace('hover:bg-blue-500', 'hover:bg-green-500');
            document.getElementById('btn-cancel').classList.add('hidden');
            
            document.getElementById('p-id').value = '';
            document.querySelectorAll('input, textarea').forEach(i => i.value = '');
        }

        init();
    </script>
</body>
</html>