<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | 1K Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body{font-family:'Kanit',sans-serif;}</style>
</head>
<body class="bg-slate-100 min-h-screen">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">ADMIN CONTROL</h1>
        <a href="/" class="text-sm bg-slate-700 px-3 py-1 rounded hover:bg-slate-600">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a>
    </nav>

    <div class="container mx-auto p-4 md:p-8 space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6 text-white shadow-lg">
                <p class="text-blue-100 text-sm font-medium">‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                <h2 class="text-3xl font-bold mt-1">‡∏ø<span id="stat-daily">0</span></h2>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-md border-l-4 border-green-500">
                <p class="text-gray-500 text-sm font-medium">‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                <h2 class="text-3xl font-bold mt-1 text-slate-800">‡∏ø<span id="stat-monthly">0</span></h2>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-md border-l-4 border-purple-500">
                <p class="text-gray-500 text-sm font-medium">‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</p>
                <h2 class="text-3xl font-bold mt-1 text-slate-800">‡∏ø<span id="stat-yearly">0</span></h2>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-md border-l-4 border-orange-500">
                <p class="text-gray-500 text-sm font-medium">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <h2 class="text-3xl font-bold mt-1 text-slate-800"><span id="stat-users">0</span> ‡∏Ñ‡∏ô</h2>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-700">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                <input type="text" id="search-user" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="border rounded-lg px-3 py-1 text-sm focus:outline-blue-500" onkeyup="filterUsers()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-600">
                    <thead class="bg-slate-100 text-slate-700 uppercase font-bold">
                        <tr>
                            <th class="p-4">ID</th>
                            <th class="p-4">Username</th>
                            <th class="p-4">Points</th>
                            <th class="p-4">Role</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <tr><td colspan="5" class="p-4 text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md overflow-hidden">
            <div class="p-6 border-b bg-slate-50">
                <h3 class="text-xl font-bold text-slate-700">üí∏ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            </div>
            <div class="overflow-x-auto h-96"> <table class="w-full text-left text-sm text-gray-600">
                    <thead class="bg-slate-100 text-slate-700 uppercase sticky top-0">
                        <tr>
                            <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="p-4">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="p-4">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th class="p-4">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        let allUsers = [];

        async function loadAdminData() {
            try {
                const res = await fetch('/api/admin_stats');
                const data = await res.json();

                // 1. ‡πÉ‡∏™‡πà Stats Dashboard
                document.getElementById('stat-daily').innerText = data.stats.daily.toLocaleString();
                document.getElementById('stat-monthly').innerText = data.stats.monthly.toLocaleString();
                document.getElementById('stat-yearly').innerText = data.stats.yearly.toLocaleString();
                document.getElementById('stat-users').innerText = data.users.length.toLocaleString();

                // 2. ‡πÉ‡∏™‡πà User Table
                allUsers = data.users;
                renderUsers(allUsers);

                // 3. ‡πÉ‡∏™‡πà History Table
                const hBody = document.getElementById('history-table-body');
                hBody.innerHTML = '';
                data.history.forEach(h => {
                    const date = new Date(h.created_at).toLocaleString('th-TH');
                    hBody.innerHTML += `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-4">${date}</td>
                            <td class="p-4 font-bold text-blue-600">${h.users?.username || 'Unknown'}</td>
                            <td class="p-4 text-green-600 font-bold">+${h.amount}</td>
                            <td class="p-4">${h.type || h.method}</td>
                        </tr>
                    `;
                });

            } catch(err) {
                console.error(err);
                Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            users.forEach(u => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50 transition">
                        <td class="p-4 font-mono text-xs text-gray-400">${u.id.substring(0,8)}...</td>
                        <td class="p-4 font-bold text-slate-800">${u.username}</td>
                        <td class="p-4 font-bold text-blue-600">${u.points.toLocaleString()}</td>
                        <td class="p-4"><span class="bg-gray-200 px-2 py-1 rounded text-xs">${u.role}</span></td>
                        <td class="p-4 text-center">
                            <button onclick="editUser('${u.id}', '${u.username}', ${u.points})" class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded shadow text-xs font-bold transition">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏≠‡∏¢‡∏ó‡πå
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function filterUsers() {
            const txt = document.getElementById('search-user').value.toLowerCase();
            const filtered = allUsers.filter(u => u.username.toLowerCase().includes(txt));
            renderUsers(filtered);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç User / ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏≠‡∏¢‡∏ó‡πå
        async function editUser(id, name, oldPoints) {
            const { value: newPoints } = await Swal.fire({
                title: `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ${name}`,
                input: 'number',
                inputLabel: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏≠‡∏¢‡∏ó‡πå (‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢)',
                inputValue: oldPoints,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                confirmButtonColor: '#3085d6',
            });

            if (newPoints && newPoints != oldPoints) {
                // ‡∏™‡πà‡∏á API Update
                await fetch('/api/admin_update_user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: id, points: newPoints })
                });
                Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                loadAdminData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
            }
        }

        loadAdminData();
    </script>
</body>
</html>